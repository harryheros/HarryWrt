name: Build HarryWrt (OpenWrt 24.10.5 Clean x86_64)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version (e.g. v1.0)"
        required: true
        default: "v1.0"
        type: string

  push:
    tags:
      - "clean-24.10.5-v*"

permissions:
  contents: write

env:
  OWRT_TAG: "v24.10.5"
  OWRT_REPO: "https://github.com/openwrt/openwrt.git"
  OWRT_BASE: "24.10.5"
  PROFILE: "clean"
  TARGET: "x86_64"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ github.event.inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            rel="$(echo "$tag" | grep -oE 'v[0-9]+(\.[0-9]+){0,2}' || true)"
            [[ -n "$rel" ]] || rel="v1.0"
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"
          echo "Release: $rel"

      - name: Free disk space and enable swap
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          df -h

          SWAP_PATH="/mnt/gh-swapfile"
          sudo swapoff "$SWAP_PATH" 2>/dev/null || true
          sudo rm -f "$SWAP_PATH" || true

          if ! sudo fallocate -l 8G "$SWAP_PATH" 2>/dev/null; then
            sudo dd if=/dev/zero of="$SWAP_PATH" bs=1M count=8192 status=progress
          fi

          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"

          sudo swapon --show
          free -h

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time \
            python3 python3-distutils python3-setuptools python3-pyelftools \
            gperf swig subversion mercurial
          git --version
          python3 --version

      - name: Clone OpenWrt source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${OWRT_TAG}" "${OWRT_REPO}" openwrt
          : > openwrt/build.log

      - name: Add Passwall packages feed (for geoview/tcping/geoip/geosite)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          # Provide packages required for offline installing luci-app-passwall2.ipk
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          tail -n +1 feeds.conf.default | sed -n '1,120p'

      - name: Add extra packages (Argon theme source)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          mkdir -p package/extra
          rm -rf package/extra/luci-theme-argon || true
          git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git package/extra/luci-theme-argon 2>&1 | tee -a build.log

      - name: Update and install feeds
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          ./scripts/feeds update -a 2>&1 | tee -a build.log
          ./scripts/feeds install -a -f 2>&1 | tee -a build.log

      - name: Apply config + run DIY (MUST be before make defconfig)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          # 1) Load .config FIRST
          cp "${GITHUB_WORKSPACE}/configs/x86_64-clean.config" .config

          # 2) Run DIY (patch Go toolchain policy + generate files/)
          chmod +x "${GITHUB_WORKSPACE}/scripts/diy.sh"
          bash "${GITHUB_WORKSPACE}/scripts/diy.sh" 2>&1 | tee -a build.log

          # 3) Expand deps
          make defconfig 2>&1 | tee -a build.log

          echo "Checking key packages in final .config..." | tee -a build.log

          MUST_Y=(
            "CONFIG_TARGET_ROOTFS_PARTSIZE=1024"
            "CONFIG_PACKAGE_luci=y"
            "CONFIG_PACKAGE_luci-ssl=y"
            "CONFIG_PACKAGE_luci-compat=y"
            "CONFIG_PACKAGE_dnsmasq-full=y"
            "CONFIG_PACKAGE_iptables-nft=y"
            "CONFIG_PACKAGE_kmod-nft-tproxy=y"
            "CONFIG_PACKAGE_kmod-nft-socket=y"
            "CONFIG_PACKAGE_kmod-nft-compat=y"
            "CONFIG_PACKAGE_kmod-tun=y"
            "CONFIG_PACKAGE_libev=y"
            "CONFIG_PACKAGE_libsodium=y"
            "CONFIG_PACKAGE_libudns=y"
            "CONFIG_PACKAGE_kmod-inet-diag=y"
            "CONFIG_PACKAGE_kmod-netlink-diag=y"
            "CONFIG_PACKAGE_coreutils=y"
            "CONFIG_PACKAGE_coreutils-base64=y"
            "CONFIG_PACKAGE_coreutils-nohup=y"
            "CONFIG_PACKAGE_libuci-lua=y"
            "CONFIG_PACKAGE_tcping=y"
            "CONFIG_PACKAGE_geoview=y"
            "CONFIG_PACKAGE_v2ray-geoip=y"
            "CONFIG_PACKAGE_v2ray-geosite=y"
          )

          missing=0
          for line in "${MUST_Y[@]}"; do
            if grep -qF "$line" .config; then
              echo "OK: $line" | tee -a build.log
            else
              echo "MISSING: $line" | tee -a build.log
              missing=1
            fi
          done

          if [[ "$missing" -ne 0 ]]; then
            echo "ERROR: One or more required config lines are missing in final .config." | tee -a build.log
            exit 1
          fi

          # Optional checks (do not fail)
          grep -qE '^CONFIG_PACKAGE_luci-theme-argon=y$' .config \
            && echo "OK: CONFIG_PACKAGE_luci-theme-argon=y (included)" | tee -a build.log \
            || echo "NOTE: luci-theme-argon not enabled (optional)" | tee -a build.log

      - name: Download sources
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make download -j"$(nproc)" 2>&1 | tee -a build.log

      - name: Build firmware
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make -j"$(nproc)" 2>&1 | tee -a build.log || make -j1 V=s 2>&1 | tee -a build.log

      - name: Organize and rename files (HarryWrt naming)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt/bin/targets/x86/64

          REL="${{ steps.meta.outputs.release }}"
          PREFIX="HarryWrt-${{ env.OWRT_BASE }}-${{ env.PROFILE }}-${REL}-${{ env.TARGET }}"

          BIOS_SQ="$(ls -1 *squashfs-combined.img.gz | head -n 1)"
          UEFI_SQ="$(ls -1 *squashfs-combined-efi.img.gz | head -n 1)"
          BIOS_E4="$(ls -1 *ext4-combined.img.gz | head -n 1)"
          UEFI_E4="$(ls -1 *ext4-combined-efi.img.gz | head -n 1)"

          cp -f "$BIOS_SQ" "${PREFIX}-squashfs-bios.img.gz"
          cp -f "$UEFI_SQ" "${PREFIX}-squashfs-uefi.img.gz"
          cp -f "$BIOS_E4" "${PREFIX}-ext4-bios.img.gz"
          cp -f "$UEFI_E4" "${PREFIX}-ext4-uefi.img.gz"

          sha256sum ${PREFIX}-*.img.gz > SHA256SUMS

          echo "Output files:"
          ls -lah ${PREFIX}-*.img.gz SHA256SUMS

      - name: Upload build log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Log-clean-${{ steps.meta.outputs.release }}
          path: openwrt/build.log

      - name: Upload firmware artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ env.PROFILE }}-${{ steps.meta.outputs.release }}-${{ env.TARGET }}
          path: |
            openwrt/bin/targets/x86/64/HarryWrt-${{ env.OWRT_BASE }}-${{ env.PROFILE }}-${{ steps.meta.outputs.release }}-${{ env.TARGET }}-*.img.gz
            openwrt/bin/targets/x86/64/SHA256SUMS

      - name: Publish GitHub Release (tag builds only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: HarryWrt Clean 24.10.5 ${{ steps.meta.outputs.release }} - x86_64
          body: |
            Base: OpenWrt 24.10.5 (x86_64)
            Profile: Clean Edition

            UI:
            - Default theme: Bootstrap (stock-like)
            - Argon theme: included as an option (switchable)

            Proxy-ready (offline-friendly Passwall2 UI install):
            - Built-in deps so local upload of luci-app-passwall2.ipk does not complain about:
              tcping / geoview / v2ray-geoip / v2ray-geosite

            Recommended images:
            - squashfs-uefi for UEFI systems
            - squashfs-bios for legacy BIOS systems

            Defaults:
            - Hostname: HarryWrt
            - Timezone: Asia/Hong_Kong

            Rootfs:
            - 1024MB (1GB)

            Integrity:
            - SHA256SUMS attached
          files: |
            openwrt/bin/targets/x86/64/HarryWrt-${{ env.OWRT_BASE }}-${{ env.PROFILE }}-${{ steps.meta.outputs.release }}-${{ env.TARGET }}-*.img.gz
            openwrt/bin/targets/x86/64/SHA256SUMS
            openwrt/build.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
