name: Build HarryWrt (OpenWrt 24.10.5 x86_64)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Select firmware profile"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - clean
          - passwall2
      release_version:
        description: "Release version (e.g. v1.0)"
        required: true
        default: "v1.0"
        type: string

  push:
    tags:
      - "clean-24.10.5-v*"
      - "pw2-24.10.5-v*"

env:
  OWRT_BASE: "24.10.5"
  OWRT_TAG: "v24.10.5"
  OWRT_REPO: "https://github.com/openwrt/openwrt.git"

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: clean
            name: Clean
            config: configs/x86_64-clean.config
            add_passwall: "false"
          - id: passwall2
            name: Passwall2
            config: configs/x86_64-passwall2.config
            add_passwall: "true"

    if: |
      github.event_name == 'workflow_dispatch' && (
        inputs.profile == 'both' ||
        inputs.profile == matrix.id
      ) || (
        matrix.id == 'clean' && startsWith(github.ref, 'refs/tags/clean-24.10.5-v')
      ) || (
        matrix.id == 'passwall2' && startsWith(github.ref, 'refs/tags/pw2-24.10.5-v')
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          rel=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            rel=$(echo "$tag" | grep -oE 'v[0-9]+(\.[0-9]+){0,2}' || echo "v1.0")
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"

      - name: Free disk space and enable swap
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          
          SWAP_PATH="/mnt/gh-swapfile"
          sudo swapoff "$SWAP_PATH" 2>/dev/null || true
          sudo rm -f "$SWAP_PATH" || true
          sudo fallocate -l 8G "$SWAP_PATH" || sudo dd if=/dev/zero of="$SWAP_PATH" bs=1M count=8192
          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"
          free -h

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time python3 python3-distutils \
            python3-setuptools python3-pyelftools gperf swig subversion mercurial

      - name: Clone OpenWrt source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${OWRT_TAG}" "${OWRT_REPO}" openwrt
          touch openwrt/build.log

      - name: Add Passwall feeds
        if: matrix.add_passwall == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default

      - name: Update and install feeds (Surgeon Edition)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          ./scripts/feeds update -a -f

          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            echo "Patching Passwall2 dependencies..."
            # 1. 物理移除報錯源碼
            rm -rf feeds/passwall_packages/geoview || true
            # 2. 修改 Makefile 移除強依賴項
            if [ -f feeds/passwall2/luci-app-passwall2/Makefile ]; then
              sed -i 's/+geoview//g' feeds/passwall2/luci-app-passwall2/Makefile
              sed -i 's/+v2ray-geoip//g' feeds/passwall2/luci-app-passwall2/Makefile
              sed -i 's/+v2ray-geosite//g' feeds/passwall2/luci-app-passwall2/Makefile
            fi
          fi

          ./scripts/feeds install -a -f

          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            ./scripts/feeds uninstall dnsmasq 2>/dev/null || true
          fi

      - name: Cache downloads (dl)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-cache-${{ matrix.id }}-${{ runner.os }}-${{ env.OWRT_BASE }}
          restore-keys: |
            dl-cache-${{ matrix.id }}-${{ runner.os }}-

      - name: Apply config and run DIY
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          # 使用絕對路徑準確定位 config 文件
          CONFIG_FILE="$GITHUB_WORKSPACE/${{ matrix.config }}"
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "Using config: $CONFIG_FILE"
          else
            echo "ERROR: Config file not found at $CONFIG_FILE"
            exit 1
          fi

          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            force_n() {
              local key="$1"
              sed -i "/^${key}=.*/d" .config
              sed -i "/^# ${key} is not set$/d" .config
              echo "# ${key} is not set" >> .config
            }
            # 強制屏蔽 Rust 及其它不穩定組件
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Client
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Server
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_tuic_client
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria2
            force_n CONFIG_PACKAGE_geoview
          fi

          # 執行 DIY 腳本（路徑加強版）
          DIY_PATH="$GITHUB_WORKSPACE/scripts/diy.sh"
          if [ -f "$DIY_PATH" ]; then
            chmod +x "$DIY_PATH"
            bash "$DIY_PATH"
          fi

          make defconfig

      - name: Download sources
        shell: bash
        run: |
          cd openwrt
          make download -j8

      - name: Build firmware
        shell: bash
        run: |
          cd openwrt
          # 2核編譯最穩定
          make -j2 || make -j1 V=s

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Log-${{ matrix.id }}-${{ steps.meta.outputs.release }}
          path: openwrt/build.log

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ matrix.id }}-${{ steps.meta.outputs.release }}
          path: openwrt/bin/targets/x86/64/*combined*.img.gz
