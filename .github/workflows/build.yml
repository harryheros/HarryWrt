name: Build HarryWrt (OpenWrt 24.10.5 x86_64)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Select firmware profile"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - clean
          - passwall2
      release_version:
        description: "Release version (e.g. v1.0)"
        required: true
        default: "v1.0"
        type: string

  push:
    tags:
      - "clean-24.10.5-v*"
      - "pw2-24.10.5-v*"

env:
  OWRT_BASE: "24.10.5"
  OWRT_TAG: "v24.10.5"
  OWRT_REPO: "https://github.com/openwrt/openwrt.git"

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: clean
            name: Clean
            config: configs/x86_64-clean.config
            add_passwall: "false"
          - id: passwall2
            name: Passwall2
            config: configs/x86_64-passwall2.config
            add_passwall: "true"

    if: |
      github.event_name == 'workflow_dispatch' && (
        inputs.profile == 'both' ||
        inputs.profile == matrix.id
      ) || (
        matrix.id == 'clean' && startsWith(github.ref, 'refs/tags/clean-24.10.5-v')
      ) || (
        matrix.id == 'passwall2' && startsWith(github.ref, 'refs/tags/pw2-24.10.5-v')
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          rel=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            if [[ "${{ matrix.id }}" == "clean" ]]; then
              rel=$(echo "$tag" | grep -oE 'v[0-9]+(\.[0-9]+){0,2}')
            else
              rel=$(echo "$tag" | grep -oE 'v[0-9]+(\.[0-9]+){0,2}')
            fi
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"

      - name: Free disk space and enable swap
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          
          SWAP_PATH="/mnt/gh-swapfile"
          sudo swapoff "$SWAP_PATH" 2>/dev/null || true
          sudo rm -f "$SWAP_PATH" || true
          sudo fallocate -l 8G "$SWAP_PATH" || sudo dd if=/dev/zero of="$SWAP_PATH" bs=1M count=8192
          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"
          free -h

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time python3 python3-distutils \
            python3-setuptools python3-pyelftools gperf swig subversion mercurial

      - name: Clone OpenWrt source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${OWRT_TAG}" "${OWRT_REPO}" openwrt
          : > openwrt/build.log

      - name: Add Passwall feeds
        if: matrix.add_passwall == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default

      - name: Update and install feeds (with Surgeon Fix)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          ./scripts/feeds update -a -f 2>&1 | tee -a build.log

          # 【核心外科手術】在 install 前修正依賴錯誤
          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            echo "Applying dependency patches..."
            # 1. 物理刪除導致報錯的組件
            rm -rf feeds/passwall_packages/geoview || true
            # 2. 修改 Makefile，移除強制依賴，避免 install -a 報錯
            if [ -f feeds/passwall2/luci-app-passwall2/Makefile ]; then
              sed -i 's/+geoview//g' feeds/passwall2/luci-app-passwall2/Makefile
              sed -i 's/+v2ray-geoip//g' feeds/passwall2/luci-app-passwall2/Makefile
              sed -i 's/+v2ray-geosite//g' feeds/passwall2/luci-app-passwall2/Makefile
            fi
          fi

          ./scripts/feeds install -a -f 2>&1 | tee -a build.log

          # 解決 dnsmasq 衝突
          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            ./scripts/feeds uninstall dnsmasq 2>/dev/null || true
          fi

      - name: Cache downloads (dl)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-cache-${{ matrix.id }}-${{ runner.os }}-${{ env.OWRT_BASE }}
          restore-keys: |
            dl-cache-${{ matrix.id }}-${{ runner.os }}-

      - name: Apply config and run DIY
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          cp "../${{ matrix.config }}" .config

          if [[ "${{ matrix.add_passwall }}" == "true" ]]; then
            force_n() {
              local key="$1"
              sed -i "/^${key}=.*/d" .config
              sed -i "/^# ${key} is not set$/d" .config
              echo "# ${key} is not set" >> .config
            }
            # 強制屏蔽 Rust 相關組件
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Client
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Server
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_tuic_client
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria
            force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria2
            force_n CONFIG_PACKAGE_geoview
          fi

          chmod +x ../scripts/diy.sh
          bash ../scripts/diy.sh 2>&1 | tee -a build.log
          make defconfig 2>&1 | tee -a build.log

      - name: Download sources
        shell: bash
        run: |
          cd openwrt
          make download -j8 2>&1 | tee -a build.log

      - name: Build firmware
        shell: bash
        run: |
          cd openwrt
          # 首次嘗試使用 2 核編譯，提高穩定性
          make -j2 2>&1 | tee -a build.log || make -j1 V=s 2>&1 | tee -a build.log

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-Log-${{ matrix.name }}-${{ steps.meta.outputs.release }}
          path: openwrt/build.log

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-Image-${{ matrix.name }}-${{ steps.meta.outputs.release }}
          path: openwrt/bin/targets/x86/64/*combined*.img.gz
