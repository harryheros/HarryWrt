name: Build HarryWrt (OpenWrt 24.10.5 x86_64)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Select firmware profile"
        required: true
        default: "both"
        type: choice
        options: [both, clean, passwall2]
      release_version:
        description: "Release version (e.g. v1.0)"
        required: true
        default: "v1.0"
      passwall_ref:
        description: "Passwall ref (tag/commit/branch), e.g. 26.2.5-1"
        required: true
        default: "26.2.5-1"
  push:
    tags:
      - "clean-24.10.5-v*"
      - "pw2-24.10.5-v*"

env:
  OWRT_BASE: "24.10.5"
  OWRT_TAG: "v24.10.5"
  OWRT_REPO: "https://github.com/openwrt/openwrt.git"

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: clean
            name: Clean
            config: configs/x86_64-clean.config
            add_passwall: "false"
            tag_prefix: "clean-24.10.5-"
          - id: passwall2
            name: Passwall2
            config: configs/x86_64-passwall2.config
            add_passwall: "true"
            tag_prefix: "pw2-24.10.5-"

    steps:
      - name: Gate (profile/tag filter)
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          event="${{ github.event_name }}"
          ref="${{ github.ref }}"
          profile="${{ github.event.inputs.profile || 'both' }}"
          mid="${{ matrix.id }}"
          prefix="${{ matrix.tag_prefix }}"

          run="false"

          if [[ "$event" == "workflow_dispatch" ]]; then
            if [[ "$profile" == "both" || "$profile" == "$mid" ]]; then
              run="true"
            fi
          elif [[ "$ref" == refs/tags/* ]]; then
            tag="${ref#refs/tags/}"
            if [[ "$tag" == ${prefix}v* ]]; then
              run="true"
            fi
          fi

          echo "run=$run" >> "$GITHUB_OUTPUT"
          echo "run=$run"
          echo "event=$event"
          echo "ref=$ref"
          echo "profile=$profile"
          echo "matrix_id=$mid"

      - name: Checkout repository
        if: steps.gate.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Determine release version
        if: steps.gate.outputs.run == 'true'
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          rel=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ github.event.inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            rel="$(echo "$tag" | grep -oE 'v[0-9]+(\.[0-9]+){0,2}' || true)"
            [[ -n "$rel" ]] || rel="v1.0"
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"
          echo "Release: $rel"

      - name: Free disk space and enable swap
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          df -h

          SWAP_PATH="/mnt/gh-swapfile"
          sudo swapoff "$SWAP_PATH" 2>/dev/null || true
          sudo rm -f "$SWAP_PATH" || true

          if ! sudo fallocate -l 8G "$SWAP_PATH" 2>/dev/null; then
            sudo dd if=/dev/zero of="$SWAP_PATH" bs=1M count=8192 status=progress
          fi

          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"
          sudo swapon --show
          free -h

      - name: Install build dependencies
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time \
            python3 python3-distutils python3-setuptools python3-pyelftools \
            gperf swig subversion mercurial
          git --version
          python3 --version

      - name: Clone OpenWrt source
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${OWRT_TAG}" "${OWRT_REPO}" openwrt
          : > openwrt/build.log

      - name: Add Passwall feeds (use main, checkout ref later)
        if: steps.gate.outputs.run == 'true' && matrix.add_passwall == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default
          tail -n 30 feeds.conf.default | tee -a build.log

      - name: Update feeds
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          ./scripts/feeds update -a 2>&1 | tee -a build.log

      - name: Checkout Passwall ref (tag/commit/branch)
        if: steps.gate.outputs.run == 'true' && matrix.add_passwall == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          PW_REF="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.passwall_ref || '26.2.5-1' }}"
          echo "Using Passwall ref: ${PW_REF}" | tee -a build.log

          for d in passwall_packages passwall2; do
            if [[ ! -d "feeds/${d}" ]]; then
              echo "ERROR: feeds/${d} is missing after feeds update." | tee -a build.log
              exit 1
            fi
            cd "feeds/${d}"
            git fetch --tags --force 2>&1 | tee -a ../../build.log
            if git rev-parse -q --verify "${PW_REF}^{commit}" >/dev/null 2>&1; then
              git checkout -f "${PW_REF}" 2>&1 | tee -a ../../build.log
            else
              echo "ERROR: ref not found in feeds/${d}: ${PW_REF}" | tee -a ../../build.log
              git tag -l | tail -n 30 | tee -a ../../build.log || true
              exit 1
            fi
            cd ../../
          done

      - name: Install feeds (full)
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          ./scripts/feeds install -a -f 2>&1 | tee -a build.log

      - name: Cache downloads (dl)
        if: steps.gate.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-cache-${{ matrix.id }}-${{ runner.os }}-${{ env.OWRT_BASE }}
          restore-keys: |
            dl-cache-${{ matrix.id }}-${{ runner.os }}-
            dl-cache-${{ matrix.id }}-
            dl-cache-

      - name: Apply config and run DIY
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          CONFIG_FILE="${GITHUB_WORKSPACE}/${{ matrix.config }}"
          if [[ ! -f "$CONFIG_FILE" ]]; then
            echo "ERROR: Config file not found: $CONFIG_FILE" | tee -a build.log
            exit 1
          fi
          cp "$CONFIG_FILE" .config
          echo "Using config: $CONFIG_FILE" | tee -a build.log

          DIY_PATH="${GITHUB_WORKSPACE}/scripts/diy.sh"
          if [[ -f "$DIY_PATH" ]]; then
            chmod +x "$DIY_PATH"
            bash "$DIY_PATH" 2>&1 | tee -a build.log
          fi

          make defconfig 2>&1 | tee -a build.log

      - name: Download sources
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make download -j"$(nproc)" 2>&1 | tee -a build.log

      - name: Build firmware
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make -j2 2>&1 | tee -a build.log || make -j1 V=s 2>&1 | tee -a build.log

      - name: Upload build log
        if: steps.gate.outputs.run == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: Log-${{ matrix.id }}-${{ steps.meta.outputs.release }}
          path: openwrt/build.log

      - name: Upload firmware
        if: steps.gate.outputs.run == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ matrix.id }}-${{ steps.meta.outputs.release }}
          path: openwrt/bin/targets/x86/64/*combined*.img.gz
