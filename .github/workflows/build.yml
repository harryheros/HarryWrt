name: Build HarryWrt (OpenWrt 24.10.5 Clean x86_64)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version"
        required: true
        default: "v1.0"
  push:
    tags:
      - "clean-24.10.5-v*"

permissions:
  contents: write

env:
  OWRT_TAG: "v24.10.5"
  OWRT_REPO: "https://github.com/openwrt/openwrt.git"
  OWRT_BASE: "24.10.5"
  PROFILE: "clean"
  TARGET: "x86_64"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "release=${{ github.event.inputs.release_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "release=${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev file wget curl python3-pyelftools

      - name: Clone OpenWrt source
        run: git clone --depth=1 --branch "${OWRT_TAG}" "${OWRT_REPO}" openwrt

      - name: Update and install feeds
        run: |
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          mkdir -p package/extra
          git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git package/extra/luci-theme-argon
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      - name: Apply config and run DIY
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          cp "${GITHUB_WORKSPACE}/configs/x86_64-clean.config" .config
          chmod +x "${GITHUB_WORKSPACE}/scripts/diy.sh"
          bash "${GITHUB_WORKSPACE}/scripts/diy.sh"
          
          # 1. 執行 defconfig 讓系統完成基本的依賴樹構建
          make defconfig

          # 2. 【核心強效鎖定】使用 sed 強行把被系統「優化掉」的兼容包改回 y
          sed -i 's/# CONFIG_PACKAGE_iptables is not set/CONFIG_PACKAGE_iptables=y/g' .config
          sed -i 's/# CONFIG_PACKAGE_ip6tables is not set/CONFIG_PACKAGE_ip6tables=y/g' .config
          sed -i 's/# CONFIG_PACKAGE_procps-ng-ps is not set/CONFIG_PACKAGE_procps-ng-ps=y/g' .config
          
          # 3. 兜底方案：如果連註釋都沒有，則直接追加
          grep -q "^CONFIG_PACKAGE_iptables=y" .config || echo "CONFIG_PACKAGE_iptables=y" >> .config
          grep -q "^CONFIG_PACKAGE_ip6tables=y" .config || echo "CONFIG_PACKAGE_ip6tables=y" >> .config
          grep -q "^CONFIG_PACKAGE_procps-ng-ps=y" .config || echo "CONFIG_PACKAGE_procps-ng-ps=y" >> .config

          # 4. 進行質檢 (注意：此後絕不再跑 make defconfig，防止被再次剔除)
          echo "Checking important packages in final .config..."
          MUST_Y=(
            "CONFIG_PACKAGE_dnsmasq-full"
            "CONFIG_PACKAGE_iptables-nft"
            "CONFIG_PACKAGE_iptables"
            "CONFIG_PACKAGE_ip6tables"
            "CONFIG_PACKAGE_kmod-nft-tproxy"
            "CONFIG_PACKAGE_kmod-nft-socket"
            "CONFIG_PACKAGE_kmod-nft-compat"
            "CONFIG_PACKAGE_kmod-tun"
            "CONFIG_PACKAGE_libev"
            "CONFIG_PACKAGE_libsodium"
            "CONFIG_PACKAGE_libudns"
            "CONFIG_PACKAGE_kmod-inet-diag"
            "CONFIG_PACKAGE_kmod-netlink-diag"
            "CONFIG_PACKAGE_coreutils"
            "CONFIG_PACKAGE_coreutils-base64"
            "CONFIG_PACKAGE_coreutils-nohup"
            "CONFIG_PACKAGE_libuci-lua"
            "CONFIG_PACKAGE_procps-ng-ps"
            "CONFIG_PACKAGE_tcping"
            "CONFIG_PACKAGE_geoview"
            "CONFIG_PACKAGE_v2ray-geoip"
            "CONFIG_PACKAGE_v2ray-geosite"
            "CONFIG_PACKAGE_xray-core"
            "CONFIG_PACKAGE_sing-box"
          )
          missing=0
          for k in "${MUST_Y[@]}"; do
            if grep -qE "^${k}=y$" .config; then
              echo "OK: ${k}=y"
            else
              echo "MISSING: ${k}=y"
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then exit 1; fi

      - name: Download sources
        run: cd openwrt && make download -j"$(nproc)"

      - name: Build firmware
        run: cd openwrt && make -j"$(nproc)" || make -j1 V=s

      - name: Organize files
        run: |
          cd openwrt/bin/targets/x86/64
          REL="${{ steps.meta.outputs.release }}"
          PREFIX="HarryWrt-${{ env.OWRT_BASE }}-${{ env.PROFILE }}-${REL}-${{ env.TARGET }}"
          cp -f "$(ls -1 *squashfs-combined-efi.img.gz | head -n 1)" "${PREFIX}-uefi.img.gz"
          sha256sum ${PREFIX}-*.img.gz > SHA256SUMS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-Firmware
          path: openwrt/bin/targets/x86/64/HarryWrt-*.img.gz

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            openwrt/bin/targets/x86/64/HarryWrt-*.img.gz
            openwrt/bin/targets/x86/64/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
