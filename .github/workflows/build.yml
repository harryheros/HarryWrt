name: Build HarryWrt (OpenWrt 24.10.5 x86_64)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Select firmware profile"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - clean
          - passwall2
      release_version:
        description: "HarryWrt release version (e.g. v1.0)"
        required: true
        default: "v1.0"
        type: string

  push:
    tags:
      - "clean-24.10.5-v*"
      - "pw2-24.10.5-v*"

env:
  OWRT_BASE: "24.10.5"

jobs:
  build_clean:
    name: Build Clean
    runs-on: ubuntu-22.04
    if: |
      github.event_name == 'workflow_dispatch' && (inputs.profile == 'both' || inputs.profile == 'clean')
      || startsWith(github.ref, 'refs/tags/clean-24.10.5-v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          rel=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            if [[ "$tag" =~ ^clean-24\.10\.5-(v[0-9]+(\.[0-9]+){0,2})$ ]]; then
              rel="${BASH_REMATCH[1]}"
            else
              echo "Invalid tag format: $tag"
              exit 1
            fi
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"

      - name: Free disk space and enable swap
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          df -h

          if sudo swapon --show | grep -q '/swapfile'; then sudo swapoff /swapfile || true; fi
          if [ -e /swapfile ]; then sudo rm -f /swapfile || true; fi

          SWAP_PATH="/swapfile"
          if ! sudo fallocate -l 8G "$SWAP_PATH" 2>/dev/null; then
            SWAP_PATH="/swapfile2"
            sudo rm -f "$SWAP_PATH" || true
            sudo fallocate -l 8G "$SWAP_PATH"
          fi

          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"
          sudo swapon --show

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time \
            python3 python3-distutils python3-setuptools python3-pyelftools \
            gperf swig \
            subversion mercurial

          python3 --version
          git --version

      - name: Clone OpenWrt source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch v24.10.5 https://github.com/openwrt/openwrt.git openwrt
          : > openwrt/build.log

      - name: Update and install feeds (Clean minimal)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          ./scripts/feeds update -a -f 2>&1 | tee -a build.log

          ./scripts/feeds install -f -p packages \
            luci luci-ssl luci-theme-argon \
            bash curl htop 2>&1 | tee -a build.log

          ls -la package/feeds/packages 2>&1 | tee -a build.log || true

      - name: Cache downloads (dl)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-cache-clean-${{ runner.os }}-${{ env.OWRT_BASE }}
          restore-keys: |
            dl-cache-clean-${{ runner.os }}-
            dl-cache-clean-
            dl-cache-

      - name: Apply config and run DIY
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          cp ../configs/x86_64-clean.config .config

          chmod +x ../scripts/diy.sh
          bash ../scripts/diy.sh 2>&1 | tee -a build.log

          make defconfig 2>&1 | tee -a build.log || { echo "defconfig failed"; tail -n 200 build.log; exit 1; }

      - name: Download sources
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make download -j$(nproc) 2>&1 | tee -a build.log

      - name: Build firmware
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make -j$(nproc) 2>&1 | tee -a build.log

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ steps.meta.outputs.release }}-Clean-x86_64-log
          path: openwrt/build.log

      - name: Upload firmware artifacts (BIOS + UEFI)
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ steps.meta.outputs.release }}-Clean-x86_64
          path: openwrt/bin/targets/x86/64/*combined*.img.gz

  build_passwall2:
    name: Build Passwall2
    runs-on: ubuntu-22.04
    if: |
      github.event_name == 'workflow_dispatch' && (inputs.profile == 'both' || inputs.profile == 'passwall2')
      || startsWith(github.ref, 'refs/tags/pw2-24.10.5-v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          rel=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            rel="${{ inputs.release_version }}"
          else
            tag="${GITHUB_REF##*/}"
            if [[ "$tag" =~ ^pw2-24\.10\.5-(v[0-9]+(\.[0-9]+){0,2})$ ]]; then
              rel="${BASH_REMATCH[1]}"
            else
              echo "Invalid tag format: $tag"
              exit 1
            fi
          fi
          echo "release=$rel" >> "$GITHUB_OUTPUT"

      - name: Free disk space and enable swap
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell || true
          df -h

          if sudo swapon --show | grep -q '/swapfile'; then sudo swapoff /swapfile || true; fi
          if [ -e /swapfile ]; then sudo rm -f /swapfile || true; fi

          SWAP_PATH="/swapfile"
          if ! sudo fallocate -l 8G "$SWAP_PATH" 2>/dev/null; then
            SWAP_PATH="/swapfile2"
            sudo rm -f "$SWAP_PATH" || true
            sudo fallocate -l 8G "$SWAP_PATH"
          fi

          sudo chmod 600 "$SWAP_PATH"
          sudo mkswap "$SWAP_PATH"
          sudo swapon "$SWAP_PATH"
          sudo swapon --show

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev \
            file wget curl ca-certificates time \
            python3 python3-distutils python3-setuptools python3-pyelftools \
            gperf swig \
            subversion mercurial

          python3 --version
          git --version

      - name: Clone OpenWrt source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch v24.10.5 https://github.com/openwrt/openwrt.git openwrt
          : > openwrt/build.log

      - name: Add Passwall feeds
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default

      - name: Update and install feeds (Passwall2 minimal + dependency defs)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          ./scripts/feeds update -a -f 2>&1 | tee -a build.log

          ./scripts/feeds install -f -p packages \
            luci luci-ssl luci-theme-argon \
            bash curl htop \
            dnsmasq-full ca-bundle \
            xray-core sing-box 2>&1 | tee -a build.log

          ./scripts/feeds install -f -p packages \
            libev libpam libtirpc net-snmp 2>&1 | tee -a build.log || true

          ./scripts/feeds install -f -p passwall2 luci-app-passwall2 2>&1 | tee -a build.log

          ls -la package/feeds/packages 2>&1 | tee -a build.log || true

      - name: Cache downloads (dl)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-cache-pw2-${{ runner.os }}-${{ env.OWRT_BASE }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            dl-cache-pw2-${{ runner.os }}-${{ env.OWRT_BASE }}-
            dl-cache-pw2-${{ runner.os }}-
            dl-cache-

      - name: Apply config and run DIY (no rust, strict, diagnostics)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          cp ../configs/x86_64-passwall2.config .config

          force_n() {
            local key="$1"
            sed -i "/^${key}=.*/d" .config
            sed -i "/^# ${key} is not set$/d" .config
            echo "# ${key} is not set" >> .config
          }

          force_n CONFIG_PACKAGE_rust
          force_n CONFIG_PACKAGE_cargo

          force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_TUIC_CLIENT
          force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_TUIC_SERVER
          force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_HYSTERIA2
          force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_SHADOW_TLS
          force_n CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_NAIVEPROXY

          chmod +x ../scripts/diy.sh
          bash ../scripts/diy.sh 2>&1 | tee -a build.log

          make defconfig 2>&1 | tee -a build.log || { echo "defconfig failed"; tail -n 200 build.log; exit 1; }

          echo "Rust/Cargo lines in .config:" | tee -a build.log
          grep -nE '^(CONFIG_PACKAGE_(rust|cargo)=|# CONFIG_PACKAGE_(rust|cargo) is not set)$' .config | tee -a build.log || true

          if grep -qE '^CONFIG_PACKAGE_rust=y$' .config || grep -qE '^CONFIG_PACKAGE_cargo=y$' .config; then
            echo "Rust/Cargo was selected by dependency tree. Investigating..." | tee -a build.log

            echo "Searching Kconfig/Makefile rust/cargo selectors (precise)..." | tee -a build.log

            grep -RInE --include='Config.in' --include='Kconfig' --include='*.in' \
              '(^|\s)(select|depends on)\s+(RUST|CARGO)(\s|$)|(^|\s)(select|depends on)\s+PACKAGE_(rust|cargo)(\s|$)|(^|\s)PACKAGE_(rust|cargo)(\s|$)' \
              package package/feeds 2>/dev/null | head -n 200 | tee -a build.log || true

            grep -RInE --include='Makefile' \
              'DEPENDS.*(\+rust|\+cargo)|\+PACKAGE_rust|\+PACKAGE_cargo' \
              package package/feeds 2>/dev/null | head -n 200 | tee -a build.log || true

            echo "Failing build to keep no-rust policy strict." | tee -a build.log
            exit 1
          fi

      - name: Download sources
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make download -j$(nproc) 2>&1 | tee -a build.log

      - name: Build firmware
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt
          make -j$(nproc) 2>&1 | tee -a build.log

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ steps.meta.outputs.release }}-Passwall2-x86_64-log
          path: openwrt/build.log

      - name: Upload firmware artifacts (BIOS + UEFI)
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-${{ env.OWRT_BASE }}-${{ steps.meta.outputs.release }}-Passwall2-x86_64
          path: openwrt/bin/targets/x86/64/*combined*.img.gz
