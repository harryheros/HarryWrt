name: Build HarryWrt (24.10.5 Passwall2 x86_64 EFI)

on:
  workflow_dispatch:
  push:
    tags:
      - "pw2-v*"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk \
            gettext git libncurses-dev libssl-dev \
            python3 python3-setuptools python3-venv \
            rsync unzip zlib1g-dev file wget curl ca-certificates \
            gcc-multilib g++-multilib time

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/build_dir
            openwrt/staging_dir
          key: harrywrt-pw2-${{ runner.os }}-24.10.5-${{ github.run_id }}
          restore-keys: |
            harrywrt-pw2-${{ runner.os }}-24.10.5-

      - name: Clone OpenWrt v24.10.5 (retry + fallback)
        shell: bash
        run: |
          set -euxo pipefail

          clone_try() {
            git clone --depth=1 --branch v24.10.5 "$1" openwrt
          }

          # Try official Git first (may 503)
          for i in 1 2 3; do
            rm -rf openwrt
            if clone_try "https://git.openwrt.org/openwrt/openwrt.git"; then
              echo "Cloned from git.openwrt.org"
              exit 0
            fi
            echo "git.openwrt.org failed (attempt $i), retrying in 10s..."
            sleep 10
          done

          # Fallback to GitHub mirror
          rm -rf openwrt
          clone_try "https://github.com/openwrt/openwrt.git"
          echo "Cloned from github.com/openwrt/openwrt.git"

      - name: Add Passwall feeds
        shell: bash
        run: |
          set -euxo pipefail
          cd openwrt
          echo "src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/Openwrt-Passwall/openwrt-passwall2.git;main" >> feeds.conf.default

      - name: Update feeds
        shell: bash
        run: |
          set -euxo pipefail
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply config
        shell: bash
        run: |
          set -euxo pipefail
          cd openwrt
          cp ../configs/x86_64-passwall2.config .config
          make defconfig

      - name: DIY branding
        shell: bash
        run: |
          set -euxo pipefail
          cd openwrt
          bash ../scripts/diy.sh

      - name: Download sources
        shell: bash
        run: |
          set -euxo pipefail
          cd openwrt
          make download -j"$(nproc)"

      - name: Build firmware (capture error)
        shell: bash
        run: |
          set -euo pipefail
          cd openwrt

          # 1) reduce parallelism to avoid OOM
          # 2) avoid V=s to prevent gigantic logs
          # 3) on failure, print the last 200 lines which always contains the real error
          (make -j2 2>&1 | tee build.log) || (echo "===== LAST 200 LINES ====="; tail -n 200 build.log; exit 1)

      - name: Collect artifacts
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p out
          cd openwrt

          IMG="$(ls -1 bin/targets/x86/64/*combined-efi.img.gz | head -n 1 || true)"
          if [ -z "${IMG}" ]; then
            echo "ERROR: combined-efi.img.gz not found"
            ls -lah bin/targets/x86/64 || true
            exit 1
          fi

          cp "$IMG" ../out/HarryWrt-24.10.5-Passwall2-x86-64-efi.img.gz
          cd ..
          sha256sum out/* | tee out/SHA256SUMS.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HarryWrt-24.10.5-Passwall2-x86-64-efi
          path: out/*
